<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link type="text/css" href="css/ui-lightness/jquery-ui-1.9.2.custom.min.css" rel="Stylesheet" />
         <style>
             .selectable .ui-selecting {
             background: #ccc;
             }
             .selectable .ui-selected {
             background: #999;
         }
         .entry {
             width:300px;
             display:inline-block;
             float:left;
             margin:1px;
             min-height:120px;
         }
         .entry_cost {
             margin:12px 2px 12px 5px;
             display:inline;
             max-width:11%;
             float:right;
         }
         .entry_name {
             margin:12px 1px 12px 1px;
             display:inline;
             float:left;
             max-width:74%;
             white-space:nowrap;
             overflow:hidden;
         } 
         .section {
             width:100%;
             overflow:auto;
         }
         .opt_select {
             display:inline;
             float:right;
             max-width:54%;
         }
         .choice {
             clear:both;
             border:solid;
             overflow:hidden;
        }
        .opt_text {
            max-width:45%;
            display:inline;
            float:left;
            margin:0px 1px 0px 0px;
            overflow:hidden;
        }
        .sub_button {
        }
        .sub_div {
            width:80%;
            height:80%;
        }
        .hidden {
            display:none;
        }
        .force_cost{
            float:right;
        }
         </style>
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery-ui.min.js"></script>
        <script type="text/javascript">
            function sub_timeout(sub_units, div) {
                 var dfd = jQuery.Deferred();
                  setTimeout(function() {
                            dfd.resolveWith(div, sub_units);
                             }, 1400);
                   return dfd.promise();
            }

            // IDs are manually generated and must remain static as they will be used for saving
            // lists
            var forces = [
                {
                    "id":1,
                    "name":"Panzer Division Battlegroup",
                    "sections":[
                        {
                            "id":1, 
                            "name":"Forward Headquarters Units",
                            "allows":'[8,10]',
                            "requires":false,
                            "entries":[
                            {
                                "id":1,
                                "name":"Forward Headquarters",
                                "cost":24,
                                "br":3,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"SdKfz 251/3","cost":0},
                                            {"id":2,"text":"SdKfz 251/6","cost":0},
                                            {"id":3,"text":"Panzer II/F","cost":0},
                                            {"id":4,"text":"Panzer III/J","cost":6},
                                            {"id":5,"text":"Panzer IV/G","cost":26},
                                            {"id":6,"text":"Panzer IV/H","cost":32},
                                            {"id":7,"text":"Tiger","cost":61},
                                        ]
                                    }
                                    
                                 ]

                            },
                            {
                                "id":2,
                                "name":"Luftwaffe Air Control Officer",
                                "cost":26,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"Kübelwagon","cost":0},
                                            {"id":2,"text":"Medium Truck","cost":2},
                                            {"id":3,"text":"SdKfz 250/3","cost":12},
                                            {"id":4,"text":"SdKfz 251/3","cost":12},
                                        ]
                                    }
                                    
                                 ]

                            },
                            {
                                "id":3,
                                "name":"Forward Signals Unit",
                                "br":1,
                                "cost":18,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"Medium Radio Truck","cost":0},
                                            {"id":2,"text":"SdKfz 251/3 Radio H.T.","cost":6},
                                            {"id":3,"text":"SdKfz 250/3 Radio H.T.","cost":6},
                                            {"id":4,"text":"SdKfz 236","cost":6},
                                            {"id":5,"text":"SdKfz 223","cost":6},
                                            {"id":6,"text":"Panzer III M","cost":42, "br":2},
                                            {"id":7,"text":"Panzer IV H","cost":50, "br":2},
                                        ]
                                    }
                                    
                                 ]

                            },
                            {
                                "id":4,
                                "name":"Comms Relay Team",
                                "br":0,
                                "cost":14,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"Kübelwagon","cost":0},
                                            {"id":2,"text":"Medium Truck","cost":2},
                                            {"id":3,"text":"SdKfz 250/3","cost":12},
                                            {"id":4,"text":"SdKfz 251/3","cost":12},
                                        ]
                                    }
                                    
                                 ]

                            },
                            {
                                "id":5,
                                "name":"Wire Team",
                                "br":0,
                                "cost":7,
                            },
                            {
                                "id":6,
                                "name":"Motorcycle Dispatch Rider",
                                "br":0,
                                "cost":12,
                            }
                            ]

                        },
                        {
                            "id":2, 
                            "name":"Infantry Units",
                            "allows":'[6,7,9]',
                            "requires":false,
                            "entries":[
                                {
                                    "id":1,
                                    "name":"Panzer Grenadier Platoon",
                                    "cost":100,
                                    "br":11,
                                    'multiplier':4,
                                    "sub_text":"Platoon Components",
                                    "sub_units":[
                                        {
                                            "id":1,
                                            "name":"Command Squad",
                                            "cost":0,
                                            "br":0,
                                            "mandatory":true,
                                            "options":[
                                                {
                                                    "name":"Transport",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Medium truck","cost":4},
                                                    ]
                                                },
                                                {
                                                    "name":"AT grenades",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Anti-tank grenades","cost":5},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":2,
                                            "name":"Panzer Grenadier Squad",
                                            "cost":0,
                                            "count":3,
                                            "br":0,
                                            "mandatory":true,
                                            "options":[
                                                {
                                                    "name":"Transport",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Medium truck","cost":4},
                                                    ]
                                                },
                                                {
                                                    "name":"MG",
                                                    "choices":[
                                                        {"id":1,"text":"Bipod MG34","cost":0},
                                                        {"id":2,"text":"Bipod MG42","cost":4},
                                                    ]
                                                },
                                                {
                                                    "name":"AT grenades",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Anti-tank grenades","cost":5},
                                                    ]
                                                },
                                            ]

                                        },
                                        {
                                            "id":3,
                                            "name":"Combat Medic",
                                            "cost":8,
                                            "br":0,
                                        },
                                        {
                                            "id":4,
                                            "name":"Light Mortar Team",
                                            "cost":12,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":5,
                                            "name":"Heavy Machine Gun team",
                                            "cost":18,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Machine Gun",
                                                    "choices":[
                                                        {"id":1,"text":"Tripod MG34","cost":0},
                                                        {"id":2,"text":"Tripod MG42","cost":4},
                                                    ]
                                                },
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":6,
                                            "name":"Anti-tank Rifle Team",
                                            "cost":14,
                                            "br":1,
                                        },
                                        {
                                            "id":7,
                                            "name":"Medium Mortar Team",
                                            "cost":24,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":8,
                                            "name":"Anti-tank Gun",
                                            "cost":27,
                                            "br":2,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"50mm PaK38","cost":0},
                                                        {"id":2,"text":"75mm PaK40","cost":14},
                                                    ]
                                                },
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                                {
                                                    "name":"Tow",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Medium truck","cost":4},
                                                        {"id":3,"text":"Opel Maultier","cost":8},
                                                        {"id":4,"text":"SdKfz 6 half track","cost":8},
                                                        {"id":5,"text":"SdKfz 251/1","cost":16},
                                                    ]
                                                },
                                            ]
                                        },
                                    ]
                                },
                                {
                                    "id":2,
                                    "name":"Armoured Assault Pioneer Platoon",
                                    "cost":199,
                                    "br":19,
                                    "restricted":true,
                                    "multiplier":4,
                                    "options":[
                                        {
                                            "name":"Troop Quality",
                                            "choices":[
                                                {"id":1,"text":"Veteran","cost":0},
                                                {"id":2,"text":"Elite","cost":55, "br":7},
                                            ]
                                        }
                                    ],
                                    "sub_text":"Platoon Components",
                                    "sub_units":[
                                        {
                                            "id":1,
                                            "name":"Command Squad",
                                            "cost":0,
                                            "br":0,
                                            "mandatory":true,
                                            "options":[
                                                {
                                                    "name":"Transport",
                                                    "choices":[
                                                        {"id":1,"text":"SdKfz 251/16","cost":0},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":2,
                                            "name":"Assault Pioneer Squad",
                                            "cost":0,
                                            "count":3,
                                            "br":0,
                                            "mandatory":true,
                                            "options":[
                                                {
                                                    "name":"Transport",
                                                    "choices":[
                                                        {"id":1,"text":"SdKfz 251/1","cost":0},
                                                    ]
                                                },
                                                {
                                                    "name":"Flame-thrower",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"One Flame-thrower","cost":10},
                                                    ]
                                                },
                                                {
                                                    "name":"Mine sweeper",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"One mine sweeper","cost":5},
                                                    ]
                                                },
                                                {
                                                    "name":"MG",
                                                    "choices":[
                                                        {"id":1,"text":"Bipod MG34","cost":0},
                                                        {"id":2,"text":"Bipod MG42","cost":4},
                                                    ]
                                                },
                                            ]

                                        },
                                        {
                                            "id":3,
                                            "name":"Combat Medic",
                                            "cost":9,
                                            "br":0,
                                        },
                                        {
                                            "id":4,
                                            "name":"Heavy Machine Gun team",
                                            "cost":21,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Machine Gun",
                                                    "choices":[
                                                        {"id":1,"text":"Tripod MG34","cost":0},
                                                        {"id":2,"text":"Tripod MG42","cost":4},
                                                    ]
                                                },
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":5,
                                            "name":"Anti-tank Rifle Team",
                                            "cost":16,
                                            "br":1,
                                        },
                                        {
                                            "id":6,
                                            "name":"Anti-tank Gun",
                                            "cost":30,
                                            "br":2,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"50mm PaK38","cost":0},
                                                        {"id":2,"text":"75mm PaK40","cost":14},
                                                    ]
                                                },
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                                {
                                                    "name":"Tow",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Medium truck","cost":4},
                                                        {"id":3,"text":"Opel Maultier","cost":8},
                                                        {"id":4,"text":"SdKfz 6 half track","cost":8},
                                                        {"id":5,"text":"SdKfz 251/1","cost":16},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":7,
                                            "name":"Self Propelled Infantry Gun",
                                            "cost":26,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"SdkFz 251/9 Halftrack","cost":0},
                                                        {"id":2,"text":"Grille","cost":16, "br":1},
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            "id":8,
                                            "name":"Towed AA Gun",
                                            "cost":31,
                                            "br":2,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"20mm FlaK","cost":0},
                                                        {"id":2,"text":"20mm FlaK vierling","cost":12},
                                                    ]
                                                },
                                                {
                                                    "name":"Tow",
                                                    "choices":[
                                                    {"id":1,"text":"None","cost":0},
                                                    {"id":2,"text":"Medium Truck","cost":4},
                                                    {"id":3,"text":"SdKfz 10 half track", "cost":8},
                                                    {"id":4,"text":"SdKfz 11 half track", "cost":8}
                                                    ]
                                                },
                                            ]
                                        },
                                    ]
                                },
                                {
                                    "id":3,
                                    "name":"Armoured Panzer Grenadier Platoon",
                                    "cost":162,
                                    "br":15,
                                    'multiplier':4,
                                    "options":[
                                        {
                                            "name":"Troop Quality",
                                            "choices":[
                                                {"id":1,"text":"Veteran","cost":0},
                                                {"id":2,"text":"Elite","cost":55, "br":7},
                                            ]
                                        }
                                    ],
                                    "sub_text":"Platoon Components",
                                    "sub_units":[
                                        {
                                            "id":1,
                                            "name":"Command Squad",
                                            "cost":0,
                                            "br":0,
                                            "mandatory":true,
                                            "options":[
                                                {
                                                    "name":"Transport",
                                                    "choices":[
                                                        {"id":1,"text":"SdKfz 251/10","cost":0},
                                                    ]
                                                },
                                                {
                                                    "name":"AT grenades",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Anti-tank grenades","cost":5},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":2,
                                            "name":"Panzer Grenadier Squad",
                                            "cost":0,
                                            "count":3,
                                            "br":0,
                                            "mandatory":true,
                                            "options":[
                                                {
                                                    "name":"Transport",
                                                    "choices":[
                                                        {"id":1,"text":"SdKfz 251/1","cost":0},
                                                    ]
                                                },
                                                {
                                                    "name":"MG",
                                                    "choices":[
                                                        {"id":1,"text":"Bipod MG34","cost":0},
                                                        {"id":2,"text":"Bipod MG42","cost":4},
                                                    ]
                                                },
                                                {
                                                    "name":"AT grenades",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Anti-tank grenades","cost":5},
                                                    ]
                                                },
                                            ]

                                        },
                                        {
                                            "id":3,
                                            "name":"Combat Medic",
                                            "cost":8,
                                            "br":0,
                                        },
                                        {
                                            "id":4,
                                            "name":"Light Mortar Team",
                                            "cost":14,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":5,
                                            "name":"Heavy Machine Gun team",
                                            "cost":21,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Machine Gun",
                                                    "choices":[
                                                        {"id":1,"text":"Tripod MG34","cost":0},
                                                        {"id":2,"text":"Tripod MG42","cost":4},
                                                    ]
                                                },
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":6,
                                            "name":"Anti-tank Rifle Team",
                                            "cost":16,
                                            "br":1,
                                        },
                                        {
                                            "id":7,
                                            "name":"Medium Mortar Team",
                                            "cost":24,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"80mm mortar","cost":0},
                                                        {"id":2,"text":"SdKfz 251/2 (80mm mortar)","cost":6},
                                                    ]
                                                },
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":8,
                                            "name":"Anti-tank Gun",
                                            "cost":27,
                                            "br":2,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"50mm PaK38","cost":0},
                                                        {"id":2,"text":"75mm PaK40","cost":14},
                                                    ]
                                                },
                                                {
                                                    "name":"Loader team",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"3-man","cost":10},
                                                    ]
                                                },
                                                {
                                                    "name":"Tow",
                                                    "choices":[
                                                        {"id":1,"text":"None","cost":0},
                                                        {"id":2,"text":"Medium truck","cost":4},
                                                        {"id":3,"text":"Opel Maultier","cost":8},
                                                        {"id":4,"text":"SdKfz 6 half track","cost":8},
                                                        {"id":5,"text":"SdKfz 251/1","cost":16},
                                                    ]
                                                },
                                            ]
                                        },
                                        {
                                            "id":9,
                                            "name":"Self Propelled Infantry Gun",
                                            "cost":26,
                                            "br":1,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"SdkFz 251/9 Halftrack","cost":0},
                                                        {"id":2,"text":"Grille","cost":16, "br":1},
                                                    ]
                                                }
                                            ]
                                        },
                                        {
                                            "id":10,
                                            "name":"Towed AA Gun",
                                            "cost":28,
                                            "br":2,
                                            "options":[
                                                {
                                                    "name":"Gun type",
                                                    "choices":[
                                                        {"id":1,"text":"20mm FlaK","cost":0},
                                                        {"id":2,"text":"20mm FlaK vierling","cost":12},
                                                    ]
                                                },
                                                {
                                                    "name":"Tow",
                                                    "choices":[
                                                    {"id":1,"text":"None","cost":0},
                                                    {"id":2,"text":"Medium Truck","cost":4},
                                                    {"id":3,"text":"SdKfz 10 half track", "cost":8},
                                                    {"id":4,"text":"SdKfz 11 half track", "cost":8}
                                                    ]
                                                },
                                            ]
                                        },
                                    ]
                                },
                                {
                                    "id":4,
                                    "name":"Panzer Grenadier Squad",
                                    "cost":26, // greg confirm
                                    "br":2,
                                    "options":[
                                        {
                                            "name":"Transport",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"Medium truck","cost":4},
                                            ]
                                        },
                                        {
                                            "name":"MG",
                                            "choices":[
                                                {"id":1,"text":"Bipod MG34","cost":0},
                                                {"id":2,"text":"Bipod MG42","cost":4},
                                            ]
                                        },
                                        {
                                            "name":"AT grenades",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"Anti-tank grenades","cost":5},
                                            ]
                                        },
                                    ]

                                },
                                {
                                    "id":5,
                                    "name":"Armoured Panzer Grenadier Squad",
                                    "cost":42,
                                    "br":3,
                                    "options":[
                                        {
                                            "name":"MG",
                                            "choices":[
                                                {"id":1,"text":"Bipod MG34","cost":0},
                                                {"id":2,"text":"Bipod MG42","cost":4},
                                            ]
                                        },
                                        {
                                            "name":"AT grenades",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"Anti-tank grenades","cost":5},
                                            ]
                                        },
                                        {
                                            "name":"Troop Quality",
                                            "choices":[
                                                {"id":1,"text":"Veteran","cost":0},
                                                {"id":2,"text":"Elite","cost":12, "br":1},
                                            ]
                                        }
                                    ]

                                },
                                {
                                    "id":6,
                                    "name":"Armoured Pioneer Squad",
                                    "cost":54,
                                    "br":3,
                                    "restricted":true,
                                    "options":[
                                        {
                                            "name":"MG",
                                            "choices":[
                                                {"id":1,"text":"Bipod MG34","cost":0},
                                                {"id":2,"text":"Bipod MG42","cost":4},
                                            ]
                                        },
                                        {
                                            "name":"Flame-thrower",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"One Flame-thrower","cost":10},
                                            ]
                                        },
                                        {
                                            "name":"Mine sweeper",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"One mine sweeper","cost":5},
                                            ]
                                        },
                                        {
                                            "name":"Troop Quality",
                                            "choices":[
                                                {"id":1,"text":"Veteran","cost":0},
                                                {"id":2,"text":"Elite","cost":12, "br":1},
                                            ]
                                        }
                                    ]

                                },
                            ],
                        },
                        {
                            "id":3, 
                            "name":"Tank Units",
                            "allows":'[6,7,8,9]',
                            "requires":false,
                            "entries":[
                                {
                                    "id":1,
                                    "name":"Panzer III Squadron",
                                    "cost":85,
                                    "multiplier":3,
                                    "br":9,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"3 Panzer III Js","cost":0},
                                                {"id":2,"text":"Upgrade to Ausf. Ls","cost":20},
                                                {"id":3,"text":"Upgrade to Ausf. Ms","cost":25},
                                            ]
                                        }
                                    ]

                                },
                                {
                                    "id":2,
                                    "name":"Panzer IV Squadron",
                                    "cost":135,
                                    "multiplier":3,
                                    "br":9,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"3 Panzer IV Gs","cost":0},
                                                {"id":2,"text":"Upgrade to Ausf. Hs","cost":15, "restricted":true},
                                            ]
                                        }
                                    ]

                                },
                                {
                                    "id":3,
                                    "name":"Panzer V Squadron",
                                    "cost":220,
                                    "multiplier":3,
                                    "restricted":true,
                                    "br":9,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"3 Panther Ds","cost":0},
                                            ]
                                        }
                                    ]

                                },
                                {
                                    "id":4,
                                    "name":"StuG III Squadron",
                                    "cost":110,
                                    "multiplier":3,
                                    "br":9,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"3 Stug III Fs","cost":0},
                                                {"id":2,"text":"Upgrade to Ausf. Gs","cost":20},
                                            ]
                                        }
                                    ]

                                },
                                {
                                    "id":5,
                                    "name":"Panzer Ace",
                                    "multiplier":0,
                                    "cost":20,
                                    "br":0,
                                },
                                {
                                    "id":6,
                                    "name":"Panzer III",
                                    "cost":30,
                                    "br":3,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"Panzer III J","cost":0, "restricted":true},
                                                {"id":2,"text":"Panzer III L","cost":9},
                                                {"id":3,"text":"Panzer III M","cost":10},
                                                {"id":4,"text":"Panzer III N","cost":8, "restricted":true},
                                            ]
                                        }
                                    ]

                                },
                                {
                                    "id":7,
                                    "name":"Panzer IV",
                                    "cost":44,
                                    "br":3,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"Panzer IV E","cost":0, "restricted":true},
                                                {"id":2,"text":"Panzer IV F1","cost":0, "restricted":true},
                                                {"id":3,"text":"Panzer IV G","cost":6},
                                                {"id":4,"text":"Panzer IV H","cost":12, "restricted":true},
                                            ]
                                        }
                                    ]

                                },
                                {
                                    "id":8,
                                    "name":"Panzer V Panther",
                                    "cost":85,
                                    "restricted":true,
                                    "br":3,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"1 Panther D","cost":0},
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "id":9,
                                    "name":"StuG III",
                                    "cost":24,
                                    "br":3,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"StuG III A-E","cost":0, "restricted":true},
                                                {"id":2,"text":"StuG III F","cost":16},
                                                {"id":3,"text":"StuG III G","cost":24},
                                            ]
                                        }
                                    ]
                                },
                                {
                                    "id":10,
                                    "name":"Panzer II",
                                    "cost":24,
                                    "restricted":true,
                                    "br":2,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"1 Panzer II F","cost":0},
                                            ]
                                        }
                                    ]
                                },
                            ],
                        },/*
                        {
                            "id":4, 
                            "name":"Artillery Units",
                            "allows":[10],
                            "requires":false,
                        },
                        {
                            "id":5, 
                            "name":"Defences",
                            "allows":null,
                            "requires":false,
                            },
                            */
                    {
                        "id":6, 
                        "name":"Reconnaissance Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Sniper",
                                "cost":10,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 sniper","cost":0},
                                            {"id":2,"text":"1 sniper + 1 spotter","cost":5},
                                        ]
                                    }
                                ]

                            },
                            {
                                "id":2,
                                "name":"Mounted Panzer Grenadier Patrol",
                                "cost":28,
                                "br":3,
                                "options":[
                                    {
                                        "name":"AT grenades",
                                        "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"Anti-tank grenades","cost":5},
                                        ]
                                    }
                                ]

                            },
                            //greg finish this section
                            //greg also make it check allows/requires BEFORE selecting a new unit
                        ],
                    },
                    {
                        "id":7, 
                        "name":"Engineer Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Light Bridging Unit",
                                "cost":18,
                                "br":2,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"Heavy Truck & 6 men","cost":0},
                                            {"id":2,"text":"SdKfz 251/7 & 6 men","cost":8},
                                        ]
                                    }
                                ]
                            },
                            {
                                "id":2,
                                "name":"Heavy Bridging Unit",
                                "cost":36,
                                "br":3,
                                "restricted":true,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"2 Heavy Trucks & 12 men","cost":0},
                                            {"id":1,"text":"3 Heavy Trucks & 18 men","cost":24},
                                            {"id":1,"text":"4 Heavy Trucks & 24 men","cost":48},
                                            {"id":1,"text":"5 Heavy Trucks & 30 men","cost":72},
                                        ]
                                    }
                                ]
                            },
                            {
                                "id":3,
                                "name":"Flammpanzer III",
                                "cost":50,
                                "br":3,
                                "restricted":true,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 Flammpanzer III Ausf. M","cost":0}
                                        ]
                                    },
                                ]
                            },
                            {
                                "id":4,
                                "name":"Recovery Vehicle",
                                "cost":18,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"SdKfz 9 'Famo'","cost":0},
                                            {"id":2,"text":"Bergpanther","cost":20, "br":1, "restricted":true},
                                        ]
                                    }
                                ]
                            },
                            {
                                "id":5,
                                "name":"Borgward Demolition Squadron",
                                "cost":74,
                                "br":5,
                                "options":[
                                    {
                                        "name":"Command",
                                        "choices":[
                                            {"id":1,"text":"StuG III Ausf. F","cost":0},
                                            {"id":2,"text":"Panzer III Ausf. L","cost":0},
                                            ]
                                    },
                                    {
                                        "name":"Borgwards",
                                        "choices":[
                                            {"id":1,"text":"1 Borgward B-IV","cost":0},
                                            {"id":2,"text":"2 Borgward B-IV","cost":10, "br":1},
                                            {"id":3,"text":"3 Borgward B-IV","cost":20, "br":2},
                                            {"id":4,"text":"4 Borgward B-IV","cost":30, "br":3},
                                        ]
                                    }
                                ]
                            },
                        ],
                    },
                    {
                        "id":8, 
                        "name":"Logistics Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Supply Column",
                                "cost":8,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 medium truck","cost":0},
                                            {"id":2,"text":"2 medium trucks","cost":4},
                                            {"id":3,"text":"3 medium trucks","cost":8},
                                            {"id":4,"text":"4 medium trucks","cost":12},
                                        ]
                                    },
                                    {
                                        "name":"Armoured carriers",
                                        "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"Replace 1 truck","cost":6},
                                        ]
                                    },

                                ]
                            },
                            {
                                "id":2,
                                "name":"Stretcher Party",
                                "cost":10,
                                "br":1,
                                "options":[
                                    {
                                    "name":"Composition",
                                    "choices":[
                                        {"id":1,"text":"2 men","cost":0}
                                    ]
                                    }
                                ]
                            },
                            {
                                "id":3,
                                "name":"Ambulance",
                                "cost":14,
                                "br":2,
                                "restricted":true,
                                "options":[
                                    {
                                    "name":"Composition",
                                    "choices":[
                                        {"id":1,"text":"Kübelwagon Ambulance","cost":0},
                                        {"id":2,"text":"Ambulance medium truck","cost":2},
                                        {"id":3,"text":"SdKfz 251/8 Ambulance","cost":6},
                                    ]
                                    }
                                ]
                            },
                            {
                                "id":4,
                                "name":"Forward Aid Post",
                                "cost":20,
                                "br":5,
                                "restricted":true,
                                "options":[
                                    {
                                    "name":"Composition",
                                    "choices":[
                                        {"id":1,"text":"4 men with a tent","cost":0}
                                    ]
                                    }
                                ]
                            },
                        ],
                    },
                    {
                        "id":9, 
                        "name":"Specialist Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Heavy Anti-Tank Gun",
                                "cost":51,
                                "br":3,
                                "options":[
                                    {
                                        "name":"Loader team",
                                        "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"3-man","cost":10},
                                        ]
                                    },
                                    {
                                        "name":"Tow",
                                        "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"SdkFz 7","cost":8},
                                        ]
                                    },

                                ]
                            },
                            {
                                "id":2,
                                "name":"Self-Propelled Anti-Tank Gun",
                                "cost":30,
                                "br":1,
                                "restricted":true,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"Marder II","cost":0},
                                            {"id":2,"text":"Marder III H","cost":4},
                                            {"id":3,"text":"Marder III M","cost":-2},
                                            {"id":4,"text":"Marder 38t (36r)","cost":4},
                                        ]
                                    }
                                ]

                            },
                            {
                                "id":3,
                                "name":"Panzer VI Squadron",
                                "cost":223,
                                "br":12,
                                "multiplier":3,
                                "options":[
                                    {
                                    "name":"Composition",
                                    "choices":[
                                        {"id":1,"text":"3 Tigers Is","cost":0, "restricted":true},
                                    ]
                                    }
                                ]
                            },
                            {
                                "id":4,
                                "name":"Heavy Tank Hunter",
                                "cost":136,
                                "br":5,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 Ferdinand","cost":0, "restricted":true},
                                            {"id":2,"text":"1 Hornisse","cost":-80, "restricted":true, "br":-2},
                                        ]
                                    },
                                ]
                            },
                            {
                                "id":5,
                                "name":"Captured Tank",
                                "cost":42,
                                "br":3,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 Panzer T-34r","cost":0}
                                        ]
                                    },
                                ]
                            },
                            {
                                "id":6,
                                "name":"Anti-Aircraft Vehicle",
                                "cost":16,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                        {"id":1,"text":"SdKfz 10 with 20mm","cost":0, "restricted":true},
                                        {"id":2,"text":"SdKfz with 37mm","cost":4, "restricted":true},
                                        {"id":3,"text":"SdKfz with 20mma Flakvierling","cost":20, "restricted":true},
                                        ]
                                    },
                                ]
                            },
                            {
                                "id":7,
                                "name":"Assault Howitzer",
                                "cost":44,
                                "br":3,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"StuH 42 F","cost":0, "restricted":true},
                                            {"id":2,"text":"StuH 42 G","cost":6, "restricted":true},
                                            {"id":3,"text":"Brummbär","cost":20, "restricted":true, "br":1},
                                        ]
                                    },
                                ]
                            },
                            {
                                "id":8,
                                "name":"Panzer VI",
                                "cost":85,
                                "br":4,
                                "restricted":true,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 Panzer VI Tiger","cost":0}
                                        ]
                                    },
                                ]
                            },
                        ],
                    },
                    {
                        "id":10, 
                        "name":"Additional Fire Support",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Off-Table Artillery Request",
                                "cost":5,
                                "br":0,
                                "options":[
                                    {
                                        "name":"Target Priority",
                                        "choices":[
                                            {"id":1,"text":"3rd (5+)","cost":0},
                                            {"id":2,"text":"2nd (4+)","cost":5},
                                            {"id":3,"text":"1st (2+)","cost":15},
                                        ]
                                    },
                                ]
                            },
                        {
                            "id":2,
                            "name":"Pre-Registered Target Point",
                            "cost":15,
                            "br":0,
                        },
                        {
                            "id":3,
                            "name":"Counter-Battery Fire Mission",
                            "cost":10,
                            "br":0,
                        },
                        {
                            "id":4,
                            "name":"Timed 105mm Barrage",
                            "cost":10,
                            "br":0,
                        },
                        {
                            "id":5,
                            "name":"Timed 150mm Barrage",
                            "cost":20,
                            "br":0,
                        },
                        {
                            "id":6,
                            "name":"Timed FW-190 Air Strike",
                            "cost":5,
                            "br":0,
                        },
                        {
                            "id":7,
                            "name":"Timed Ju-87 Air Strike",
                            "cost":15,
                            "br":0,
                        },
                        {
                            "id":8,
                            "name":"Timed He-111 Air Strike",
                            "cost":25,
                            "restricted":true,
                            "br":0,
                        },
                        ],
                    },
                    ],
                },
                {
                    "id":2,
                    "name":"Second Battlegroup",
                    "sections":[
                        {
                            "id":9, 
                            "name":"Specialist Support Units",
                            "allows":null,
                            "requires":true,
                            "entries":[
                                {
                                    "id":1,
                                    "name":"Heavy Anti-Tank Gun",
                                    "cost":51,
                                    "br":3,
                                    "options":[
                                        {
                                            "name":"Loader team",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"3-man","cost":10},
                                            ]
                                        },
                                        {
                                            "name":"Tow",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"SdkFz 7","cost":8},
                                            ]
                                        },

                                    ]
                                },
                                {
                                    "id":2,
                                    "name":"Heavy Tank Hunter",
                                    "cost":136,
                                    "br":5,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"1 Ferdinand","cost":0, "restricted":true},
                                                {"id":2,"text":"1 Hornisse","cost":-80, "restricted":true, "br":-2},
                                            ]
                                        },
                                    ]
                                },
                                {
                                    "id":3,
                                    "name":"Assault Howitzer",
                                    "cost":44,
                                    "br":3,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"StuH 42 F","cost":0, "restricted":true},
                                                {"id":2,"text":"StuH 42 G","cost":6, "restricted":true},
                                                {"id":3,"text":"Brummbär","cost":20, "restricted":true, "br":1},
                                            ]
                                        },
                                    ]
                                },
                                {
                                    "id":4,
                                    "name":"Anti-Aircraft Vehicle",
                                    "cost":16,
                                    "br":1,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                            {"id":1,"text":"SdKfz 10 with 20mm","cost":0, "restricted":true},
                                            {"id":2,"text":"SdKfz with 37mm","cost":4, "restricted":true},
                                            {"id":3,"text":"SdKfz with 20mma Flakvierling","cost":20, "restricted":true},
                                            ]
                                        },
                                    ]
                                },
                                {
                                    "id":5,
                                    "name":"Towed 20mm AA Gun",
                                    "cost":28,
                                    "br":1,
                                    "options":[
                                        {
                                            "name":"Loader team",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"3-man","cost":10},
                                                ]
                                        },
                                        {
                                            "name":"Tow",
                                            "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"Medium Truck tow","cost":4},
                                            {"id":3,"text":"SdKfz halftrack", "cost":4}
                                            ]
                                        },
                                    ]
                                },
                                {
                                    "id":6,
                                    "name":"Towed 37mm AA Gun",
                                    "cost":36,
                                    "br":1,
                                    "options":[
                                        {
                                            "name":"Loader team",
                                            "choices":[
                                                {"id":1,"text":"None","cost":0},
                                                {"id":2,"text":"3-man","cost":10},
                                                ]
                                        },
                                        {
                                            "name":"Tow",
                                            "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"Medium Truck tow","cost":4},
                                            {"id":3,"text":"SdKfz halftrack", "cost":8}
                                            ]
                                        },
                                    ]
                                },
                            ],
                        },
                    ],
                },
                ];

function render_sub_units_to(sub) {
//    $(this).removeClass('hidden'); // greg
    $(this).html(render_entries(sub, true));
    $(this).bind("mousedown", function(e) {
            e.metaKey = true;
            }).selectable({ filter: '.entry', tolerance: "fit", unselecting:unselecting, unselected:unselected, selected:selected });
    $('body').append($(this));
}

function perm(inArr, choose, callback, callback_arg) {
    var c = [];
    var found = false;
    var inner = function(tmpArray, choose_) {
        if ( found )
            return;
        if (choose_ == 0) {
            found = callback(c, callback_arg);
        } else {
            for (var i = 0; i < tmpArray.length; ++i) {
                c.push(tmpArray[i]);
                var newArray = tmpArray.slice(0);
                newArray.splice(i, 1);
                inner(newArray, choose_ - 1);
                c.pop();
            }
        }
    }
    inner(inArr, choose);
    return found;
}

function requires_match(item, requires) {
    //alert(JSON.stringify(requires)+' => ' +JSON.stringify(item));
    for (var i=0; i<item.length; i++) {
        if ($.inArray(requires[i], item[i]) == -1)
            return false;
    }
    return true;
}


// maybe make it get which value from a select?
function render_name(force) {
    var text = "<div class='ui-dialog-titlebar ui-widget-header ui-corner-all ui-helper-clearfix'><span class='ui-dialog-title'>"+force['name']+"</span><span class='force_cost' id='force_cost'>0</span></div>"
    return(text);
}
function render_sections(force) {
    var text="";
    for(var i = 0; i < force['sections'].length; i++) {
        text = text + "<div class='group'><h3>" + force['sections'][i].name+"</h3>";
        text = text + "<div data-allows='"+ force['sections'][i].allows +"' class='section ui-widget ";
        if (force.sections[i].requires)
            text = text + "ui-state-disabled' data-requires='true'";
        else
            text = text + "selectable ' data-requires='false'";
        text = text + " id=section_" + force['sections'][i].id + " data-section-no="+ force['sections'][i].id + ">";
        text = text+render_entries(force['sections'][i]['entries'], false);
        text = text + "</div></div>";
    }
    return text;
}

function get_allows() {
    var selected = $('.ui-selected').filter( function() {
        return ($(this).parent().data('allows')); //only entries with a data-allows field
    });
    var array = $.map(selected, function(a)
    { // take allows 'multiplier' into account when calculating allows
        var rv = [];
        for (var i=0; i<($(a).data('multiplier')); i++) {
            rv.push($(a).parent().data('allows'));
        }
        return rv;
    });
    return array;
}
function count_allows() {
    var array = get_allows();
    var totals={};
    for (var i=0; i<array.length; i++){
        for (var j=0; j<array[i].length; j++){
            if (totals[array[i][j]])
                totals[array[i][j]]=totals[array[i][j]]+1;
            else
                totals[array[i][j]]=1;
        }
    }
    return totals;
}
function count_requires() {
    var selected = $('.ui-selected');
    var requires = {};
    var array = $.map(selected, function(a)
        { 
            if ($(a).parent().data('requires')) {
                var rv=[];
                for (var i=0; i<($(a).data('multiplier')); i++) {
                    rv.push($(a).parent().data('section-no'));
                }
                return rv;
            }
        });
    return array;
}

function allow_requires() {
    var requires = count_requires();
    if (requires.length == 0) // no requirements, auto pass
        return true;
    var allows = get_allows();
    if (allows.length == 0) // no allows but requirements, fail
        return false;
    //alert('allows length is ' +allows.length + 'requires.length is ' + requires.length);
    if ( allows.length > 0 && requires.length <= allows.length )
        return perm(allows, requires.length, requires_match, requires);
    return false;
}

function allow_removed() {
    var requires = $('.section').filter( function() { return $(this).data('requires'); } );
    $(requires).addClass('ui-state-disabled');
    $(requires).removeClass('selectable');
}

function allow_enables() {
    var allows = count_allows();
    for (var key in allows) {
        var section = $('#section_'+key);
        section.removeClass('ui-state-disabled');
        section.addClass('selectable');
        // greg section.css('background:EEE');
    }
    update_dynamic();
}

function render_entries(entries, sub_entries) {
    var text="";
    for(var i = 0; i < entries.length; i++) {
        var count = 1;
        if (entries[i].count) {
            count = entries[i].count;
        }
        for (var count_loop=0; count_loop<count; count_loop++) {
            text = text + "<div data-multiplier='";
            if (entries[i].multiplier)
                text = text + entries[i].multiplier;
            else {
                if (entries[i].multiplier == 0)
                    text = text + "0";
                else
                    text = text + "1";
            }
            if ( entries[i]['sub_units'] ) {
                var div = $('<div class="selectable">').addClass('sub_div hidden');
                $(div).uniqueId();
                text = text + "' data-sub='" + $(div).attr('id');
                jQuery.when( sub_timeout([entries[i]['sub_units']], div)).done(render_sub_units_to);
            }
            if (sub_entries)
                text = text + "' data-sub_entry='true";
            text = text + "' class='entry ui-widget-content";
            if ( entries[i]['mandatory'] )
                text = text + ' ui-selected mandatory';
            text = text + "'><div><p class='entry_name'>"+entries[i].name+"</p><p id='cost' data-initial-cost='"+entries[i].cost+"' class='entry_cost'>"+entries[i].cost+"</p><p class='entry_cost' id='br' data-initial-br='"+entries[i].br+"'>"+entries[i].br+"<font size='1.2em'>BR</font></p></div>";
            //greg here
            if ( entries[i]['options'] ) {
                for(var j = 0; j < entries[i]['options'].length; j++) {
                    text = text + '<div class="choice"><p class="opt_text">'+entries[i]['options'][j]['name']+'</p><select class="opt_select" name="' + entries[i]['options'][j]['name']+'">';
                    for (var k=0; k<entries[i].options[j].choices.length; k++) {
                        text = text + "<option data-cost='"+entries[i].options[j].choices[k].cost;
                        if (entries[i].options[j].choices[k].br)
                           text = text +"' data-br='"+entries[i].options[j].choices[k].br; 
                        text = text + "' value='" + entries[i].options[j].choices[k].id +"'>"+entries[i].options[j].choices[k].text + "</option>"; 
                    }
                    text = text + "</select></div>";
                }
            }
            if ( entries[i]['sub_units'] )
                text = text + "<button class='sub_button'>"+entries[i]['sub_text']+"</button>";
            text = text + "</div>"
        }
    }
    return text;
}

function render_force(which) {
    var text="";
    var force = forces[which];
    text = render_name(force);
    text = text + "<div id='accordion'>" + render_sections(force) + "</div>";
    $('#main').html(text);

}

function render() {
    render_force(0);
}

// Function gets selected entries but excludes any sub entries whose parent entry
// is currently un-selected
function get_selected_entries() {
    return $('.ui-selected').filter( function() {
        // check if they are a sub entry - if so require parent entry to be selected
        if ($(this).data('sub_entry')) {
            if ($(this).parents('.ui-selectable').data('sub_parent') &&
                $('#'+$(this).parents('.ui-selectable').data('sub_parent')).hasClass('ui-selected'))
                    return true;
            return false;
        }
        return true; } );
}

function update_cost() {
    var cost = 0;
    var br=0;
    var entries = get_selected_entries();
    $(entries).each(function() {
            cost = cost + parseInt($(this).find('#cost').text());
            br = br + parseInt($(this).find('#br').text());});
    $('#force_cost').text(cost + ' ' + br +'br');
}

function unselecting(event, ui){
    var abort = false;
    // If removing this would stop us meeting our requires, then prevent its removal
    if ($(ui.unselecting).hasClass('mandatory'))
        abort = true;
    else if ($(ui.unselecting).parents('.section').data('allows')) {
        if ( !allow_requires() ) {
            alert('Removing this item would result in you having more support choices than allowed.\nRemove those first.');
            abort=true;
        }
    }
    if (abort)
        $(ui.unselecting).addClass('ui-selected');

}
function unselected(event, ui){
    update_cost();
    allow_removed();
    allow_enables();
    update_dynamic();
}

//greg see if allow_requires is valid when using a selecting callback


function selected(event, ui){
    update_cost();
    allow_enables(); // greg see if this item provides any allows first

}

function update_entry_cost(entry) {
    var cost_field = $(entry).find('p').filter( function() { return $(this).attr('id')=='cost'; });
    var br_field = $(entry).find('p').filter( function() { return $(this).attr('id')=='br'; });
    var selects = $(entry).find("select option").filter(':selected');
    var newCost = $(cost_field).data('initial-cost');
    var newBr = $(br_field).data('initial-br');

    for (var i=0; i<selects.length; i++) {
        newCost = newCost + $(selects[i]).data('cost');
        if ($(selects[i]).data('br')){
            newBr = newBr + $(selects[i]).data('br');
        }
    }
    $(cost_field).html(newCost);
    $(br_field).html(newBr+"<font size='1.2em'>BR</font>");
    update_cost();
}

function option_change(event) {
    update_entry_cost($(this).parents(".entry"));
}


function update_dynamic(){
    $("#accordion").accordion({
        heightStyle: "content",
        header: '> div > h3',
        }).sortable({
        axis: "y",
        handle: "h3",
        stop: function( event, ui ) {
            // IE doesn't register the blur when sorting
            // so trigger focusout handlers to remove .ui-state-focus
            ui.item.children( "h3" ).triggerHandler( "focusout" );
        }
    });
    $(".sub_button").button().click(function( event ) {
        event.preventDefault();
        var parent = $(this).parent();
        var sub = $('#'+parent.data('sub'));
        // Apply a uniqueId to the sub's owner and put it in the sub div's data
        // so that the sub div can reference its owner
        $(parent).uniqueId();
        sub.data('sub_parent', $(parent).attr('id'));
        sub.dialog({title:$(this).html(), modal:true, width:'950'});
    });
    $( ".selectable" ).bind("mousedown", function(e) {
            e.metaKey = true;
            }).selectable({ filter: '.entry', tolerance: "fit", unselecting:unselecting, unselected:unselected, selected:selected });
    $(".opt_select").change(option_change);
}

    $( document ).ready( function() {
            render();
            update_dynamic();
        });
        </script>
    </head>
    <body>
<div id="main" style="width:100%; clear:both;" class="ui-widget">An error has occurred in the javascript rendering of this page. Do you have an uptodate browser?</div>


</body></html>

