<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <link type="text/css" href="css/ui-lightness/jquery-ui-1.9.2.custom.min.css" rel="Stylesheet" />
         <style>
             .selectable .ui-selecting {
             background: #ccc;
             }
             .selectable .ui-selected {
             background: #999;
         }
         .entry {
             width:250px;
             display:inline-block;
             float:left;
             margin:1px;
         }
         .entry_name {
             display:inline;
             float:left;
         }
         .section {
             width:100%;
             overflow:auto;
         }
         .opt_select {
             display:inline;
             float:right;
             max-width:54%;
         }
         .choice {
             clear:both;
             border:solid;
             overflow:hidden;
        }
        .opt_text {
            max-width:45%;
            display:inline;
            float:left;
            margin:0px 1px 0px 0px;
            overflow:hidden;
        }
         </style>
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery-ui.min.js"></script>
        <script type="text/javascript">
            // should IDs be programatically generated greg, seems like it would be safer and less hassle
            // in the long wrong
            // but what if using ids in saving/sharing lists? Can't have them changing!
            var forces = [
                {
                    "id":1,
                    "name":"Panzer Division Battlegroup",
                    "sections":[
                        {
                            "id":1, 
                            "name":"Forward Headquarters Units",
                            "allows":[8,10],
                            "requires":false,
                            "entries":[
                            {
                                "id":1,
                                "name":"Forward Headquarters",
                                "cost":24,
                                "br":3,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"SdKfz 251/3","cost":0},
                                            {"id":2,"text":"SdKfz 251/6","cost":0},
                                            {"id":3,"text":"Panzer II/F","cost":0},
                                            {"id":4,"text":"Panzer III/J","cost":6},
                                            {"id":5,"text":"Panzer IV/G","cost":26},
                                            {"id":6,"text":"Panzer IV/H","cost":32},
                                            {"id":7,"text":"Tiger","cost":61},
                                        ]
                                    }
                                    
                                 ]

                            },
                            {
                                "id":2,
                                "name":"Luftwaffe Air Control Officer",
                                "cost":26,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"Kübelwagon","cost":0},
                                            {"id":2,"text":"Medium Truck","cost":2},
                                            {"id":3,"text":"SdKfz 250/3","cost":12},
                                            {"id":4,"text":"SdKfz 251/3","cost":12},
                                        ]
                                    }
                                    
                                 ]

                            },
                            {
                                "id":3,
                                "name":"Forward Signals Unit",
                                "br":1,
                                "cost":18,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"Medium Radio Truck","cost":0},
                                            {"id":2,"text":"SdKfz 251/3 Radio H.T.","cost":6},
                                            {"id":3,"text":"SdKfz 250/3 Radio H.T.","cost":6},
                                            {"id":4,"text":"SdKfz 236","cost":6},
                                            {"id":5,"text":"SdKfz 223","cost":6},
                                            {"id":6,"text":"Panzer III M","cost":42, "br":2},
                                            {"id":7,"text":"Panzer IV H","cost":50, "br":2},
                                        ]
                                    }
                                    
                                 ]

                            },
                            {
                                "id":4,
                                "name":"Comms Relay Team",
                                "br":0,
                                "cost":14,
                                "options":[
                                    {
                                        "name":"Transport",
                                        "choices":[
                                            {"id":1,"text":"Kübelwagon","cost":0},
                                            {"id":2,"text":"Medium Truck","cost":2},
                                            {"id":3,"text":"SdKfz 250/3","cost":12},
                                            {"id":4,"text":"SdKfz 251/3","cost":12},
                                        ]
                                    }
                                    
                                 ]

                            }
                            ]

                        },
                        {
                            "id":2, 
                            "name":"Infantry Units",
                            "allows":[6,7,8],
                            "requires":false,
                            "entries":[
                                {
                                    "id":1,
                                    "name":"Sniper",
                                    "cost":10,
                                    "br":1,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"1 man","cost":0},
                                                {"id":2,"text":"+Spotter","cost":5},
                                            ]
                                        }
                                    ]

                                },
                            ],
                        },
                        {
                            "id":3, 
                            "name":"Tank Units",
                            "allows":[6,7,8],
                            "requires":false,
                            "entries":[
                                {
                                    "id":1,
                                    "name":"Sniper",
                                    "cost":10,
                                    "br":1,
                                    "options":[
                                        {
                                            "name":"Composition",
                                            "choices":[
                                                {"id":1,"text":"1 man","cost":0},
                                                {"id":2,"text":"+Spotter","cost":5},
                                            ]
                                        }
                                    ]

                                },
                            ],
                        },/*
                        {
                            "id":4, 
                            "name":"Artillery Units",
                            "allows":[6,7,8],
                            "requires":false,
                        },
                        {
                            "id":5, 
                            "name":"Defences",
                            "allows":null,
                            "requires":false,
                            },
                            */
                    {
                        "id":6, 
                        "name":"Reconnaissance Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Sniper",
                                "cost":10,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 man","cost":0},
                                            {"id":2,"text":"+Spotter","cost":5},
                                        ]
                                    }
                                ]

                            },
                        ],
                    },
                    {
                        "id":7, 
                        "name":"Engineer Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Light Bridging Unit",
                                "cost":18,
                                "br":2,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"Heavy Truck","cost":0},
                                            {"id":2,"text":"SdKfz 251/7","cost":8},
                                        ]
                                    }
                                ]
                            },
                        ],
                    },
                    {
                        "id":8, 
                        "name":"Logistics Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Supply Column",
                                "cost":8,
                                "br":1,
                                "options":[
                                    {
                                        "name":"Composition",
                                        "choices":[
                                            {"id":1,"text":"1 medium truck","cost":0},
                                            {"id":2,"text":"2 medium trucks","cost":4},
                                            {"id":3,"text":"3 medium trucks","cost":8},
                                            {"id":4,"text":"4 medium trucks","cost":12},
                                        ]
                                    },
                                    {
                                        "name":"Armoured carriers",
                                        "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"Replace 1 truck","cost":6},
                                        ]
                                    },

                                ]
                            },
                        ],
                    },
                    {
                        "id":9, 
                        "name":"Specialist Support Units",
                        "allows":null,
                        "requires":true,
                        "entries":[
                            {
                                "id":1,
                                "name":"Heavy Anti-Tank Gun",
                                "cost":51,
                                "br":3,
                                "options":[
                                    {
                                        "name":"Loader team",
                                        "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"3-man","cost":10},
                                        ]
                                    },
                                    {
                                        "name":"Tow",
                                        "choices":[
                                            {"id":1,"text":"None","cost":0},
                                            {"id":2,"text":"SdkFz 7","cost":8},
                                        ]
                                    },

                                ]
                            },
                        ],
                    },
                    ],
                },
                {
                    "id":2,
                    "name":"Second Battlegroup",
                },
                ];

function perm(inArr, choose, callback, callback_arg) {
    var c = [];
    var found = false;
    var inner = function(tmpArray, choose_) {
        if ( found ) {
            alert('found');
            return;}
        if (choose_ == 0) {
            found = callback(c, callback_arg);
        } else {
            for (var i = 0; i < tmpArray.length; ++i) {
                c.push(tmpArray[i]);
                var newArray = tmpArray.slice(0);
                newArray.splice(i, 1);
                inner(newArray, choose_ - 1);
                c.pop();
            }
        }
    }
    inner(inArr, choose);
    alert('found value: ' + found);
    return found;
}

function requires_match(item, requires) {
    alert(JSON.stringify(requires)+' => ' +JSON.stringify(item));
    for (var i=0; i<item.length; i++) {
        alert('testing ' + requires[i] + ' against ' + JSON.stringify(item[i]));
        //greg if its one entry is it an array still?
        var haystack = item[i].split(',');
        if ($.inArray(requires[i], haystack) == -1) {
            for (var j=0; j<haystack.length; j++)
                alert('haystack['+j+'] is ' + haystack[j]);
            return false;
        }
        else
            alert('inarray match');
    }
    return true;
}


// maybe make it get which value from a select?
function render_name(force) {
    return("<p>"+force['name']+"</p>");
}
function render_sections(force) {
    var text="";
    for(var i = 0; i < force['sections'].length; i++) {
        text = text + "<div class='group'><h3>" + force['sections'][i].name+"</h3>";
        text = text + "<div data-allows='"+ force['sections'][i].allows +"' class='section ui-widget ";
        if (force.sections[i].requires)
            text = text + "ui-state-disabled' data-requires='true'";
        else
            text = text + "selectable ' data-requires='false'";
        text = text + " id=section_" + force['sections'][i].id + " data-section-no="+ force['sections'][i].id + ">";
        text = text+render_entries(force['sections'][i]);
        text = text + "</div></div>";
    }
    return text;
}

function get_allows() {
    var selected = $('.ui-selected');
    var array = $.map(selected, function(a)
           // { alert($(a).parent().attr('id'));} );
    { return ($(a).parent().data('allows')); } );
    return array;
}
function count_allows() {
    var array = get_allows();
    var totals={};
    for (var i=0; i<array.length; i++){
        var values = array[i].split(',');
        for (var j=0; j<values.length; j++){
            if (totals[values[j]])
                totals[values[j]]=totals[values[j]]+1; // should use multiplier
            else
                totals[values[j]]=1; // should use multiplier
        }
    }
    return totals;
}
function count_requires() {
    var selected = $('.ui-selected');
    var requires = {};
    var array = $.map(selected, function(a)
            { if ($(a).parent().data('requires'))
                return ($(a).parent().data('section-no')); // greg should use multiplier
            });
    //alert(JSON.stringify(array));
    return array;
}

function allow_requires() {
    var requires = count_requires();
    if (requires.length == 0) // no requirements, auto pass
        return true;
    var allows = get_allows();
    if (allows.length == 0) // no allows but requirements, fail
        return false;
    if ( allows.length > 0 && requires.length <= allows.length )
        return perm(allows, requires.length, requires_match, requires);
    return false;

    /*alert(JSON.stringify(requires));
    alert(JSON.stringify(allows));
    alert(JSON.stringify(requires)); */
}

function allow_removed() {
    var requires = $('.section').filter( function() { return $(this).data('requires'); } );
    $(requires).addClass('ui-state-disabled');
    $(requires).removeClass('selectable');
}

function allow_enables() {
    var allows = count_allows();
    for (var key in allows) {
        var section = $('#section_'+key);
        section.removeClass('ui-state-disabled');
        section.addClass('selectable');
        // greg section.css('background:EEE');
    }
    update_dynamic();
    //alert(JSON.stringify(totals));
}

function render_entries(section) {
    var text="";
    for(var i = 0; i < section['entries'].length; i++) {
        text = text + "<div data-allows-multiplier='"+ section['entries'][i].allows_multiplier + "' class='entry ui-widget-content'>";
        text = text + "<div><p class='entry_name'>"+section['entries'][i].name+"</p><p id='cost' data-initial-cost='"+section['entries'][i].cost+"' style='display:inline; float:right;'>"+section['entries'][i].cost+"</p></div>";
        for(var j = 0; j < section['entries'][i]['options'].length; j++) {
            text = text + '<div class="choice"><p class="opt_text">'+section['entries'][i]['options'][j]['name']+'</p><select class="opt_select" name="' + section['entries'][i]['options'][j]['name']+'">';
            for (var k=0; k<section.entries[i].options[j].choices.length; k++) {
                text = text + "<option data-cost='"+section.entries[i].options[j].choices[k].cost+"' value='" + section.entries[i].options[j].choices[k].id +"'>"+section.entries[i].options[j].choices[k].text + "</option>"; 
            }
            text = text + "</select></div>";
        }



        text = text + "</div>"
    }
    return text;
}

function render_force(which) {
    var text="";
    var force = forces[which];
    text = render_name(force);
    text = text + "<div id='accordion'>" + render_sections(force) + "</div>";
    $('#main').html(text);

}

function render() {
    render_force(0);
}

function unselecting(event, ui){
    // If removing this would stop us meeting our requires, then prevent its removal
    if ($(ui.unselecting).parents('.section').data('allows')) {
        if ( !allow_requires() ) {
            $(ui.unselecting).addClass('ui-selected');
            alert('Removing this item would result in you having more support choices than allowed.\nRemove those first.');
        }
    }

}
function unselected(event, ui){
    allow_removed();
    allow_enables();
    update_dynamic();
}

function selected(event, ui){
    allow_enables(); // greg see if this item provides any allows first

}

function update_entry_cost(entry) {
    var cost_field = $(entry).find('p').filter( function() { return $(this).attr('id')=='cost'; });
    var selects = $(entry).find("select option").filter(':selected');
    var newCost = $(cost_field).data('initial-cost');

    for (var i=0; i<selects.length; i++)
        newCost = newCost + $(selects[i]).data('cost');
    $(cost_field).html(newCost);
}

function option_change(event) {
    update_entry_cost($(this).parents(".entry"));
}


function update_dynamic(){
    $("#accordion").accordion({
        heightStyle: "content",
        header: '> div > h3',
        }).sortable({
        axis: "y",
        handle: "h3",
        stop: function( event, ui ) {
            // IE doesn't register the blur when sorting
            // so trigger focusout handlers to remove .ui-state-focus
            ui.item.children( "h3" ).triggerHandler( "focusout" );
        }
    });
    $( ".selectable" ).bind("mousedown", function(e) {
            e.metaKey = true;
            }).selectable({ filter: '.entry', tolerance: "fit", unselecting:unselecting, unselected:unselected, selected:selected });
    $(".opt_select").change(option_change);
}

    $( document ).ready( function() {
            render();
            update_dynamic();
        });
// greg http://stackoverflow.com/questions/4492987/programmatically-unselect-a-jquery-ui-selectable-widget
        </script>
    </head>
    <body>
<div id="main" style="width:100%; clear:both;" class="ui-widget">An error has occurred in the javascript rendering of this page. Do you have an uptodate browser?</div>


</body></html>

